<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-populate/1.21.0/xlsx-populate.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      max-height: 95vh;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      text-align: center;
      flex-shrink: 0;
    }
    .header h1 { font-size: 22px; margin-bottom: 8px; }
    .date-selector {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 15px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 8px;
    }
    .date-selector input {
      background: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 2px solid #e9ecef;
      flex-shrink: 0;
    }
    .stat-card { text-align: center; padding: 8px; }
    .stat-number { font-size: 24px; font-weight: bold; margin-bottom: 3px; }
    .stat-label { color: #6c757d; font-size: 12px; }
    .stat-card.present .stat-number { color: #28a745; }
    .stat-card.absent .stat-number { color: #dc3545; }
    .stat-card.pending .stat-number { color: #ffc107; }
    .table-container { padding: 15px 20px; overflow-y: auto; flex: 1; min-height: 0; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th {
      background: #495057;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      font-size: 14px;
    }
    td { padding: 10px; border-bottom: 1px solid #e9ecef; font-size: 13px; }
    tr:hover { background: #f8f9fa; }
    .tower-name { font-weight: 500; color: #212529; }
    .status-btn {
      padding: 6px 16px;
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      flex: 1;
      background: white;
      color: #6c757d;
      border-color: #dee2e6;
    }
    .btn-group { display: flex; gap: 8px; }
    .status-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border-color: #adb5bd;
    }
    .status-btn.active.present { background: #28a745; color: white; border-color: #28a745; }
    .status-btn.active.absent { background: #dc3545; color: white; border-color: #dc3545; }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px 20px;
      justify-content: center;
      background: #f8f9fa;
      border-top: 2px solid #e9ecef;
      flex-shrink: 0;
    }
    .action-btn {
      padding: 10px 25px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
    .action-btn.save { background: #28a745; color: white; }
    .action-btn.clear { background: #6c757d; color: white; }
    .download-link {
      text-align: center;
      margin-top: 8px;
    }
    .download-link a {
      display: inline-block;
      margin-top: 6px;
      padding: 8px 16px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
    }
    .download-link a:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Technology Towers Attendance Dashboard</h1>
      <div class="date-selector">
        <input type="date" id="datePicker">
      </div>
    </div>

    <div class="stats">
      <div class="stat-card present">
        <div class="stat-number" id="presentCount">0</div>
        <div class="stat-label">Present</div>
      </div>
      <div class="stat-card absent">
        <div class="stat-number" id="absentCount">0</div>
        <div class="stat-label">Absent</div>
      </div>
      <div class="stat-card pending">
        <div class="stat-number" id="pendingCount">17</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <div class="table-container">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>Technology Towers</th>
            <th>Attendance Status</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="actions">
      <button class="action-btn save" id="saveBtn">ðŸ“¥ Save to Excel</button>
      <button class="action-btn clear" id="clearBtn">ðŸ”„ Clear All</button>
      <!-- Download link will appear here -->
      <div class="download-link" id="downloadArea"></div>
    </div>
  </div>

  <script>
    const towers = [
      "DL IN FR-NETWORK", "DL FR IN ALE Batchmgmt", "DL FR IN ALE ISO SAP",
      "DL FR IN SAP FAST", "DL IN OSF DBA SQL", "DL IN OSF DBA ORACLE",
      "DL CN ALE MS Support", "DL IN ALE IAM Support", "DL IN ALE CSU EPS",
      "VTOM ADMIN", "Apps - CG ALE DWH", "DL IN IM BOXI ADMIN",
      "IS - CG ALE PKI", "Cloud COS RUN AWS FRNC", "COS Network",
      "SFO - RDS", "Cloud Security"
    ];

    let attendance = {};
    let selectedDate = new Date().toISOString().split("T")[0];

    const datePicker = document.getElementById("datePicker");
    const tableBody = document.getElementById("tableBody");
    const presentCount = document.getElementById("presentCount");
    const absentCount = document.getElementById("absentCount");
    const pendingCount = document.getElementById("pendingCount");
    const downloadArea = document.getElementById("downloadArea");

    datePicker.value = selectedDate;
    datePicker.addEventListener("change", () => { selectedDate = datePicker.value; });

    function updateStats() {
      const present = Object.values(attendance).filter(s => s === "Present").length;
      const absent = Object.values(attendance).filter(s => s === "Absent").length;
      const pending = towers.length - present - absent;
      presentCount.textContent = present;
      absentCount.textContent = absent;
      pendingCount.textContent = pending;
    }

    function buildTable() {
      tableBody.innerHTML = "";
      towers.forEach(name => {
        const row = tableBody.insertRow();
        const nameCell = row.insertCell();
        nameCell.className = "tower-name";
        nameCell.textContent = name;

        const btnCell = row.insertCell();
        const btnGroup = document.createElement("div");
        btnGroup.className = "btn-group";

        const presentBtn = document.createElement("button");
        presentBtn.textContent = "Present";
        presentBtn.className = "status-btn";

        const absentBtn = document.createElement("button");
        absentBtn.textContent = "Absent";
        absentBtn.className = "status-btn";

        presentBtn.onclick = () => {
          if (attendance[name] === "Present") {
            delete attendance[name];
            presentBtn.className = "status-btn";
          } else {
            attendance[name] = "Present";
            presentBtn.className = "status-btn active present";
            absentBtn.className = "status-btn";
          }
          updateStats();
        };

        absentBtn.onclick = () => {
          if (attendance[name] === "Absent") {
            delete attendance[name];
            absentBtn.className = "status-btn";
          } else {
            attendance[name] = "Absent";
            absentBtn.className = "status-btn active absent";
            presentBtn.className = "status-btn";
          }
          updateStats();
        };

        if (attendance[name] === "Present") {
          presentBtn.className = "status-btn active present";
        } else if (attendance[name] === "Absent") {
          absentBtn.className = "status-btn active absent";
        }

        btnGroup.appendChild(presentBtn);
        btnGroup.appendChild(absentBtn);
        btnCell.appendChild(btnGroup);
      });
    }

    // Modified Save Function: shows a clickable download link
    document.getElementById("saveBtn").onclick = () => {
      XlsxPopulate.fromBlankAsync().then(workbook => {
        const sheet = workbook.sheet(0);

        sheet.cell("A1").value("Technology Towers").style({
          bold: true, fill: "4472C4", fontColor: "FFFFFF", fontSize: 12
        });

        const dateObj = new Date(selectedDate);
        const formattedDate = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        sheet.cell("B1").value(formattedDate).style({
          bold: true, fill: "4472C4", fontColor: "FFFFFF", fontSize: 12
        });

        towers.forEach((name, i) => {
          sheet.cell("A" + (i + 2)).value(name);
          let cell = sheet.cell("B" + (i + 2));
          if (attendance[name] === "Present") {
            cell.value("Present").style({ fill: "00FF00", fontColor: "000000", bold: true });
          } else if (attendance[name] === "Absent") {
            cell.value("Absent").style({ fill: "FF0000", fontColor: "FFFFFF", bold: true });
          } else {
            cell.value("").style("fill", "FFFF00");
          }
        });

        sheet.column("A").width(30);
        sheet.column("B").width(15);

        workbook.outputAsync().then(blob => {
          const url = window.URL.createObjectURL(blob);

          // clear old link if present
          downloadArea.innerHTML = "";

          // create new link
          const link = document.createElement("a");
          link.href = url;
          link.download = `attendance-${selectedDate}.xlsx`;
          link.textContent = "â¬‡ Click here to download Excel";

          downloadArea.appendChild(link);
        });
      });
    };

    document.getElementById("clearBtn").onclick = () => {
      const userConfirmed = confirm("Are you sure you want to clear all attendance data?");
      if (userConfirmed) {
        attendance = {};
        buildTable();
        updateStats();
        downloadArea.innerHTML = ""; // clear old download link
      }
    };

    buildTable();
    updateStats();
  </script>
</body>
</html>

